<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bug Board</title>
    <!-- 1. Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 2. Configure Tailwind -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'primary': '#6400aa',   // BT Purple
                        'primary-dark': '#4b0080',
                        'secondary': '#009ba4', // EE Teal
                        'secondary-dark': '#007c83',
                    },
                    animation: {
                        'fade-in-up': 'fadeInUp 0.5s ease-out',
                        'bounce-short': 'bounceShort 1s infinite'
                    },
                    keyframes: {
                        fadeInUp: {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        },
                        bounceShort: {
                            '0%, 100%': { transform: 'translateY(-5%)', animationTimingFunction: 'cubic-bezier(0.8, 0, 1, 1)' },
                            '50%': { transform: 'translateY(0)', animationTimingFunction: 'cubic-bezier(0, 0, 0.2, 1)' },
                        }
                    }
                },
            },
        };
    </script>
    <!-- 3. Load Google Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- 4. Load Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; }
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .modal { transition: opacity 0.2s ease, visibility 0.2s; visibility: hidden; opacity: 0; }
        .modal.active { visibility: visible; opacity: 1; }
        .modal-content { transform: scale(0.95); transition: transform 0.2s ease; }
        .modal.active .modal-content { transform: scale(1); }

        /* Toast Notifications */
        #toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 100; display: flex; flex-direction: column; gap: 10px; }
        .toast { min-width: 300px; padding: 16px; border-radius: 8px; background: white; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); border-left: 4px solid; animation: slideIn 0.3s ease-out forwards; display: flex; align-items: center; justify-content: space-between; }
        .toast.success { border-left-color: #10b981; }
        .toast.error { border-left-color: #ef4444; }
        .toast.info { border-left-color: #3b82f6; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 min-h-screen flex flex-col">
    
    <!-- Toast Container -->
    <div id="toast-container"></div>

    <!-- App Loader -->
    <div id="app-loader" class="fixed inset-0 z-[60] flex flex-col items-center justify-center bg-white transition-opacity duration-500">
        <div class="relative w-20 h-20 mb-4">
            <div class="absolute inset-0 border-4 border-slate-100 rounded-full"></div>
            <div class="absolute inset-0 border-4 border-primary rounded-full border-t-transparent animate-spin"></div>
        </div>
        <h3 class="text-xl font-semibold text-slate-700 tracking-tight">Loading Bug Board...</h3>
    </div>

    <!-- Sidebar -->
    <div id="sidebar-overlay" class="fixed inset-0 bg-slate-900/50 z-30 opacity-0 pointer-events-none transition-opacity duration-300"></div>
    <aside id="sidebar" class="fixed top-0 left-0 w-72 h-full bg-white shadow-2xl z-40 transform -translate-x-full transition-transform duration-300 flex flex-col">
        <div class="p-6 border-b border-slate-100">
            <h2 class="text-2xl font-bold text-primary flex items-center gap-2">
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"></path></svg>
                Bug Board
            </h2>
            <p class="text-xs text-slate-400 mt-1">Operational Issue Tracker</p>
        </div>
        <nav class="flex-grow p-4 space-y-1 overflow-y-auto">
            <button data-page="submit" class="nav-link w-full text-left p-3 rounded-lg font-medium text-slate-600 hover:bg-slate-50 hover:text-primary flex items-center gap-3 transition-colors">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                Submit New Issue
            </button>
            <button data-page="pending" class="nav-link w-full text-left p-3 rounded-lg font-medium text-slate-600 hover:bg-slate-50 hover:text-primary flex items-center gap-3 transition-colors">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                Pending Approvals
            </button>
            <button data-page="known" class="nav-link w-full text-left p-3 rounded-lg font-medium text-slate-600 hover:bg-slate-50 hover:text-primary flex items-center gap-3 transition-colors">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                Known Issues
            </button>
            <button data-page="completed" class="nav-link w-full text-left p-3 rounded-lg font-medium text-slate-600 hover:bg-slate-50 hover:text-primary flex items-center gap-3 transition-colors">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                Fixed Issues
            </button>
            <button data-page="metrics" class="nav-link w-full text-left p-3 rounded-lg font-medium text-slate-600 hover:bg-slate-50 hover:text-primary flex items-center gap-3 transition-colors">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                Metrics
            </button>
        </nav>
        <div class="p-4 border-t border-slate-100 bg-slate-50">
            <button id="logout-btn" class="w-full flex items-center gap-2 text-sm font-medium text-slate-500 hover:text-red-600 transition-colors p-2 rounded-lg hover:bg-red-50">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                Log Out
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <div class="flex-grow flex flex-col transition-all duration-300">
        <!-- Header -->
        <header class="sticky top-0 bg-white/80 backdrop-blur-md border-b border-slate-200 z-20">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-16">
                    <div class="flex items-center gap-4">
                        <button id="hamburger-btn" class="p-2 text-slate-600 hover:text-primary rounded-md hover:bg-slate-100 transition-colors">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
                        </button>
                        <h1 id="header-title" class="text-xl font-bold text-slate-800">Dashboard</h1>
                    </div>
                    <div class="flex items-center gap-4">
                        <div class="text-right hidden sm:block">
                            <div class="text-xs text-slate-400 uppercase font-semibold tracking-wider" id="user-role-display">Role</div>
                            <div class="text-sm font-medium text-slate-700" id="user-name-display">Loading...</div>
                        </div>
                        <div class="h-8 w-8 rounded-full bg-primary/10 flex items-center justify-center text-primary font-bold" id="user-avatar">
                            U
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Page Content -->
        <main class="flex-grow p-4 md:p-8 max-w-7xl mx-auto w-full">
            
            <!-- Search Bar (Visible on Known/Fixed/Pending) -->
            <div id="global-search-container" class="hidden mb-6">
                <div class="relative max-w-md mx-auto md:mx-0 md:w-96">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <svg class="h-5 w-5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                    </div>
                    <input type="text" id="global-search-input" class="block w-full pl-10 pr-3 py-2 border border-slate-300 rounded-full leading-5 bg-white placeholder-slate-400 focus:outline-none focus:border-primary focus:ring-1 focus:ring-primary sm:text-sm transition duration-150 ease-in-out" placeholder="Search issues...">
                </div>
            </div>

            <!-- Page: Submit -->
            <div id="page-submit" class="page-content hidden animate-fade-in-up">
                <div class="max-w-2xl mx-auto bg-white p-8 rounded-2xl shadow-sm border border-slate-200">
                    <div class="text-center mb-8">
                        <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-primary/10 text-primary mb-4">
                            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                        </div>
                        <h2 class="text-2xl font-bold text-slate-800">Report a New Issue</h2>
                        <p class="text-slate-500 mt-1">Found a bug? Let the TL team know.</p>
                    </div>

                    <form id="new-ticket-form" class="space-y-6">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-2">Issue Title</label>
                            <input type="text" id="ticket-title" placeholder="Brief summary of the problem" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary outline-none transition" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-2">Description</label>
                            <textarea id="ticket-desc" rows="4" placeholder="Detailed description including steps to reproduce..." class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary outline-none transition" required></textarea>
                        </div>
                        <button type="submit" class="w-full bg-primary text-white font-semibold py-3 px-4 rounded-lg shadow hover:bg-primary-dark active:scale-[0.98] transition-all duration-150">
                            Submit Issue
                        </button>
                    </form>
                </div>
            </div>

            <!-- Page: Pending -->
            <div id="page-pending" class="page-content hidden animate-fade-in-up">
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                    <div class="flex justify-between items-end mb-6">
                        <div>
                            <h2 class="text-lg font-bold text-slate-800">Pending Approval</h2>
                            <p class="text-sm text-slate-500">Review new submissions from Guides.</p>
                        </div>
                    </div>
                    <div id="new-tickets-list" class="space-y-4"></div>
                </div>
            </div>

            <!-- Page: Known Issues -->
            <div id="page-known" class="page-content hidden animate-fade-in-up">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Persistent -->
                    <section class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 flex flex-col">
                        <div class="flex items-center gap-3 mb-6 pb-4 border-b border-slate-100">
                            <div class="p-2 bg-red-100 text-red-600 rounded-lg">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                            </div>
                            <div>
                                <h2 class="text-lg font-bold text-slate-800">Persistent Issues</h2>
                                <p class="text-xs text-slate-500">Ongoing known outages</p>
                            </div>
                        </div>
                        <div id="persistent-issues-list" class="space-y-4 flex-grow"></div>
                    </section>

                    <!-- New & Important -->
                    <section class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 flex flex-col">
                        <div class="flex items-center gap-3 mb-6 pb-4 border-b border-slate-100">
                            <div class="p-2 bg-secondary/20 text-secondary rounded-lg">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.147-6.15M18 13a3 3 0 100-6M5.436 13.683A4.001 4.001 0 017 6h1.832c4.1 0 7.625-1.234 9.168-3v14c-1.543-1.766-5.067-3-9.168-3H7a3.988 3.988 0 01-1.564-.317z"></path></svg>
                            </div>
                            <div>
                                <h2 class="text-lg font-bold text-slate-800">New & Important</h2>
                                <p class="text-xs text-slate-500">Recently reported issues</p>
                            </div>
                        </div>
                        <div id="new-issues-list" class="space-y-4 flex-grow"></div>
                    </section>
                </div>
            </div>

            <!-- Page: Fixed -->
            <div id="page-completed" class="page-content hidden animate-fade-in-up">
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                        <div>
                            <h2 class="text-lg font-bold text-slate-800">Fixed Issues</h2>
                            <p class="text-sm text-slate-500">Archive of resolved tickets.</p>
                        </div>
                        <button id="download-completed-btn" class="text-sm bg-slate-100 hover:bg-slate-200 text-slate-700 font-medium py-2 px-4 rounded-lg transition flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                            Export CSV
                        </button>
                    </div>
                    <div id="completed-tickets-list" class="space-y-4"></div>
                </div>
            </div>

            <!-- Page: Metrics -->
            <div id="page-metrics" class="page-content hidden animate-fade-in-up">
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-lg font-bold text-slate-800">Daily Metrics</h2>
                        <button id="download-metrics-btn" class="text-sm bg-slate-100 hover:bg-slate-200 text-slate-700 font-medium py-2 px-4 rounded-lg transition flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                            Export CSV
                        </button>
                    </div>

                    <!-- Stats Cards -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-8">
                        <div class="p-6 bg-gradient-to-br from-primary/5 to-primary/20 rounded-xl border border-primary/10">
                            <div class="text-sm font-medium text-primary mb-1">Total Affected Reports (Today)</div>
                            <div id="metric-total-affected" class="text-4xl font-bold text-primary tracking-tight">0</div>
                        </div>
                        <div class="p-6 bg-gradient-to-br from-secondary/5 to-secondary/20 rounded-xl border border-secondary/10">
                            <div class="text-sm font-medium text-secondary mb-1">Unique Affected Agents (Today)</div>
                            <div id="metric-unique-affected" class="text-4xl font-bold text-secondary tracking-tight">0</div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div>
                            <h3 class="text-md font-semibold mb-4 text-slate-700 uppercase tracking-wider text-xs">Top 5 Issues</h3>
                            <div id="top-5-list" class="space-y-3"></div>
                        </div>
                        <div class="flex flex-col items-center justify-center">
                            <h3 class="text-md font-semibold mb-4 text-slate-700 uppercase tracking-wider text-xs">Distribution</h3>
                            <div class="relative w-full max-w-xs aspect-square">
                                <canvas id="metrics-pie-chart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- MODALS -->
    
    <!-- Modal Backdrop -->
    <div id="modal-backdrop" class="fixed inset-0 z-50 bg-slate-900/60 backdrop-blur-sm hidden transition-opacity duration-300 opacity-0"></div>

    <!-- Common Modal Container -->
    <div id="modal-container" class="fixed inset-0 z-50 flex items-center justify-center p-4 pointer-events-none">
        
        <!-- Affected Report Modal -->
        <div id="affected-modal" class="modal bg-white w-full max-w-md p-0 rounded-2xl shadow-2xl pointer-events-auto flex flex-col max-h-[90vh]">
            <div class="p-6 border-b border-slate-100">
                <h3 class="text-xl font-bold text-slate-800">Report Impact</h3>
                <p class="text-sm text-slate-500">Let us know you are affected by this issue.</p>
            </div>
            <form id="affected-form" class="p-6 overflow-y-auto">
                <input type="hidden" id="affected-ticket-id">
                <div class="mb-4">
                    <label class="block text-xs font-semibold text-slate-500 uppercase tracking-wider mb-2">Your Name</label>
                    <input type="text" id="affected-name" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-lg text-slate-600 cursor-not-allowed" readonly>
                </div>
                <div class="mb-6">
                    <label class="block text-xs font-semibold text-slate-500 uppercase tracking-wider mb-2">Additional Comments (Optional)</label>
                    <textarea id="affected-comments" rows="3" placeholder="Specific errors, workstation ID, etc." class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-secondary focus:border-secondary outline-none"></textarea>
                </div>
                <div class="flex justify-end gap-3">
                    <button type="button" class="modal-close-btn px-4 py-2 text-slate-600 font-medium hover:bg-slate-100 rounded-lg transition">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-secondary text-white font-medium rounded-lg hover:bg-secondary-dark shadow-sm transition">Submit Report</button>
                </div>
            </form>
        </div>

        <!-- Complete Issue Modal -->
        <div id="complete-modal" class="modal bg-white w-full max-w-md p-0 rounded-2xl shadow-2xl pointer-events-auto flex flex-col max-h-[90vh]">
            <div class="p-6 border-b border-slate-100">
                <h3 class="text-xl font-bold text-slate-800">Resolve Issue</h3>
                <p class="text-sm text-slate-500">Mark this issue as fixed and archive it.</p>
            </div>
            <form id="complete-form" class="p-6 overflow-y-auto">
                <input type="hidden" id="complete-ticket-id">
                <div class="mb-6">
                    <label class="block text-xs font-semibold text-slate-500 uppercase tracking-wider mb-2">Resolution Details</label>
                    <textarea id="complete-description" rows="4" placeholder="What was the fix? e.g., 'Rolled back update', 'Server restart'..." class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary outline-none" required></textarea>
                </div>
                <div class="flex justify-end gap-3">
                    <button type="button" class="modal-close-btn px-4 py-2 text-slate-600 font-medium hover:bg-slate-100 rounded-lg transition">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-primary text-white font-medium rounded-lg hover:bg-primary-dark shadow-sm transition">Mark Resolved</button>
                </div>
            </form>
        </div>

        <!-- Affected List Modal -->
        <div id="affected-guides-modal" class="modal bg-white w-full max-w-lg p-0 rounded-2xl shadow-2xl pointer-events-auto flex flex-col max-h-[80vh]">
            <div class="p-6 border-b border-slate-100 flex justify-between items-center">
                <div>
                    <h3 class="text-lg font-bold text-slate-800">Impacted Users</h3>
                    <p class="text-xs text-slate-500">Reports from the last 24 hours</p>
                </div>
                <button type="button" class="modal-close-btn text-slate-400 hover:text-slate-600 bg-slate-50 p-2 rounded-full">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div id="affected-guides-list" class="p-6 overflow-y-auto space-y-2 flex-grow bg-slate-50/50"></div>
        </div>

    </div>

    <!-- Login Modal -->
    <div id="login-modal" class="fixed inset-0 z-[70] flex items-center justify-center p-4 bg-slate-100 hidden">
        <div class="bg-white w-full max-w-sm rounded-2xl shadow-2xl overflow-hidden">
            <div class="p-8 bg-slate-900 text-white text-center relative overflow-hidden">
                <div class="absolute top-0 left-0 w-full h-full bg-gradient-to-br from-primary to-secondary opacity-50"></div>
                <div class="relative z-10">
                    <h3 class="text-2xl font-bold mb-1">Welcome</h3>
                    <p class="text-slate-200 text-sm">Sign in to Bug Board</p>
                </div>
            </div>
            
            <div class="p-8">
                <!-- Tabs -->
                <div class="flex bg-slate-100 p-1 rounded-xl mb-6">
                    <button id="guide-tab-btn" class="flex-1 py-2 text-sm font-medium rounded-lg transition-all shadow-sm bg-white text-primary">Guide</button>
                    <button id="tl-tab-btn" class="flex-1 py-2 text-sm font-medium rounded-lg text-slate-500 hover:text-slate-700 transition-all">Team Leader</button>
                </div>

                <!-- Guide Form -->
                <form id="guide-login-form" class="space-y-4 animate-fade-in-up">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Name</label>
                        <input type="text" id="name-input" placeholder="e.g. Jane Doe" class="w-full p-3 border border-slate-200 rounded-lg focus:border-secondary focus:ring-1 focus:ring-secondary outline-none" required>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">EIN</label>
                        <input type="text" id="ein-input" placeholder="e.g. 123456" class="w-full p-3 border border-slate-200 rounded-lg focus:border-secondary focus:ring-1 focus:ring-secondary outline-none" required>
                    </div>
                    <button type="submit" id="guide-login-btn" class="w-full py-3 bg-secondary text-white font-bold rounded-lg hover:bg-secondary-dark transition shadow-lg shadow-secondary/30 mt-2">
                        Login
                    </button>
                </form>

                <!-- TL Form -->
                <form id="tl-login-form" class="space-y-4 hidden animate-fade-in-up">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Access Code</label>
                        <input type="password" id="tl-code-input" placeholder="••••••••" class="w-full p-3 border border-slate-200 rounded-lg focus:border-primary focus:ring-1 focus:ring-primary outline-none" required>
                    </div>
                    <button type="submit" id="tl-login-btn" class="w-full py-3 bg-primary text-white font-bold rounded-lg hover:bg-primary-dark transition shadow-lg shadow-primary/30 mt-2">
                        Verify Access
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- SCRIPTS -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, getDoc, addDoc, setDoc, updateDoc, onSnapshot, serverTimestamp, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIGURATION ---
        // Replace with your actual Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyBeci550NSuYHxGNctUPCEozou92w8n0Rw",
            authDomain: "my-bug-board.firebaseapp.com",
            projectId: "my-bug-board",
            storageBucket: "my-bug-board.appspot.com",
            messagingSenderId: "276540108265",
            appId: "1:276540108265:web:7f32c71f66e34f4d582f78",
            measurementId: "G-Y6BL20YLJW"
        };

        // --- GLOBAL STATE ---
        let app, db, auth;
        let currentUser = { id: null, name: null, role: null, ein: null };
        let globalSnapshot = null;
        let metricsChart = null;
        let currentPage = 'known';
        let currentSearchTerm = ''; // For filtering
        
        // Collections
        const COLL = { TICKETS: 'tickets', USERS: 'users', TL_CODES: 'tl_codes' };

        // UI Elements
        const els = {
            appLoader: document.getElementById('app-loader'),
            sidebar: document.getElementById('sidebar'),
            sidebarOverlay: document.getElementById('sidebar-overlay'),
            pages: document.querySelectorAll('.page-content'),
            navLinks: document.querySelectorAll('.nav-link'),
            headerTitle: document.getElementById('header-title'),
            userName: document.getElementById('user-name-display'),
            userRole: document.getElementById('user-role-display'),
            userAvatar: document.getElementById('user-avatar'),
            loginModal: document.getElementById('login-modal'),
            searchInput: document.getElementById('global-search-input'),
            searchContainer: document.getElementById('global-search-container'),
            modalBackdrop: document.getElementById('modal-backdrop'),
            modals: document.querySelectorAll('.modal')
        };

        // --- TOAST NOTIFICATION SYSTEM ---
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            let icon = '';
            if(type === 'success') icon = `<svg class="w-6 h-6 text-emerald-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>`;
            else if(type === 'error') icon = `<svg class="w-6 h-6 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;
            else icon = `<svg class="w-6 h-6 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;

            toast.innerHTML = `
                <div class="flex items-center gap-3">
                    ${icon}
                    <span class="text-sm font-medium text-slate-700">${message}</span>
                </div>
                <button onclick="this.parentElement.remove()" class="text-slate-400 hover:text-slate-600 ml-4">&times;</button>
            `;

            container.appendChild(toast);
            
            // Remove after 4 seconds
            setTimeout(() => {
                toast.style.animation = 'fadeOut 0.3s ease-out forwards';
                setTimeout(() => toast.remove(), 300);
            }, 4000);
        }

        // --- INITIALIZATION ---
        async function init() {
            // Initialize Firebase directly with the config
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            // Auth State Listener
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    currentUser.id = user.uid;
                    checkLocalSession();
                } else {
                    // Ensure we are signed in anonymously for DB access
                    try {
                        await signInAnonymously(auth);
                    } catch (e) {
                        console.error(e);
                        showToast("Connection Error. Check console.", "error");
                        els.appLoader.classList.add('hidden');
                    }
                }
            });

            setupEventListeners();
        }

        function checkLocalSession() {
            const role = localStorage.getItem('userRole');
            const name = localStorage.getItem('userName');
            const ein = localStorage.getItem('userEIN');

            if (role && name) {
                // Validate session integrity
                if (role === 'guide' && !ein) {
                    clearSession();
                    return;
                }
                loginSuccess(role, name, ein, false); // false = don't write to DB yet, wait for app load
            } else {
                els.loginModal.classList.remove('hidden');
                els.appLoader.classList.add('hidden');
            }
        }

        async function loginSuccess(role, name, ein, isNewLogin = true) {
            currentUser.role = role;
            currentUser.name = name;
            currentUser.ein = ein;

            // UI Updates
            els.userName.textContent = name;
            els.userRole.textContent = role === 'tl' ? 'Team Leader' : 'Guide';
            els.userAvatar.textContent = name.charAt(0).toUpperCase();
            
            localStorage.setItem('userRole', role);
            localStorage.setItem('userName', name);
            if(ein) localStorage.setItem('userEIN', ein);

            // Hide login, show loader temporarily
            els.loginModal.classList.add('hidden');
            if(isNewLogin) els.appLoader.classList.remove('hidden');

            // Role-based Nav
            updateNavVisibility();

            // Start Data Stream
            startDataListener();

            // Sync User to DB
            await syncUserToDB();
        }

        function clearSession() {
            localStorage.clear();
            signOut(auth).then(() => window.location.reload());
        }

        async function syncUserToDB() {
            try {
                const userRef = doc(db, COLL.USERS, currentUser.id);
                await setDoc(userRef, {
                    name: currentUser.name,
                    role: currentUser.role,
                    ein: currentUser.ein || null,
                    lastLogin: serverTimestamp(),
                    name_lowercase: currentUser.name.toLowerCase()
                }, { merge: true });
            } catch (e) {
                console.error("Sync failed", e);
            }
        }

        function updateNavVisibility() {
            const submitBtn = document.querySelector('button[data-page="submit"]');
            const pendingBtn = document.querySelector('button[data-page="pending"]');
            const metricsBtn = document.querySelector('button[data-page="metrics"]');
            
            if (currentUser.role === 'guide') {
                submitBtn.style.display = 'none';
                pendingBtn.style.display = 'none';
                // Ensure we don't stay on a hidden page
                if(currentPage === 'submit' || currentPage === 'pending') currentPage = 'known';
            } else {
                submitBtn.style.display = 'flex';
                pendingBtn.style.display = 'flex';
            }
            renderPage(currentPage);
        }

        // --- DATA HANDLING ---
        function startDataListener() {
            const q = query(collection(db, COLL.TICKETS));
            onSnapshot(q, (snapshot) => {
                globalSnapshot = snapshot;
                renderAppContent();
                els.appLoader.classList.add('hidden'); // App is ready
            }, (error) => {
                console.error(error);
                showToast("Error fetching data.", "error");
                els.appLoader.classList.add('hidden');
            });
        }

        function renderAppContent() {
            if (!globalSnapshot) return;

            const tickets = [];
            globalSnapshot.forEach(doc => tickets.push({ id: doc.id, ...doc.data() }));

            // Filter by Search Term
            const filteredTickets = tickets.filter(t => {
                const searchStr = (t.title + ' ' + t.description).toLowerCase();
                return searchStr.includes(currentSearchTerm);
            });

            // Sort helpers
            const oneDayAgo = new Date(Date.now() - 86400000);
            const startOfToday = new Date(); startOfToday.setHours(0,0,0,0);

            // 1. Render Pending
            if (currentUser.role === 'tl') {
                const pending = filteredTickets.filter(t => t.status === 'PENDING' || (t.status === 'REJECTED' && t.rejectedAt?.toDate() > oneDayAgo));
                pending.sort((a, b) => (b.createdAt?.toDate() || 0) - (a.createdAt?.toDate() || 0));
                renderList('new-tickets-list', pending, renderPendingCard);
            }

            // 2. Render Known Issues
            const known = filteredTickets.filter(t => t.status === 'KNOWN');
            // Calculate daily metrics for sorting
            known.forEach(t => {
                t.dailyCount = (t.affectedUsers || []).filter(u => u.timestamp?.toDate() > startOfToday).length;
            });
            
            const persistent = known.filter(t => t.isPermanent).sort((a, b) => b.dailyCount - a.dailyCount);
            const newIssues = known.filter(t => !t.isPermanent).sort((a, b) => b.dailyCount - a.dailyCount);

            renderList('persistent-issues-list', persistent, renderStandardCard);
            renderList('new-issues-list', newIssues, renderStandardCard);

            // 3. Render Completed
            const completed = filteredTickets.filter(t => t.status === 'COMPLETE');
            completed.sort((a, b) => (b.completedAt?.toDate() || 0) - (a.completedAt?.toDate() || 0));
            renderList('completed-tickets-list', completed, renderCompletedCard);

            // 4. Metrics (Always calculate on full dataset, ignoring search filter for accuracy)
            updateMetrics(tickets, startOfToday);
        }

        // Generic List Renderer
        function renderList(elementId, data, renderFn) {
            const el = document.getElementById(elementId);
            if (!el) return;
            el.innerHTML = '';
            if (data.length === 0) {
                el.innerHTML = `
                    <div class="flex flex-col items-center justify-center py-8 text-slate-400">
                        <svg class="w-12 h-12 mb-2 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path></svg>
                        <p class="text-sm font-medium">No tickets found</p>
                    </div>`;
                return;
            }
            data.forEach(item => el.appendChild(renderFn(item)));
        }

        // --- CARD RENDERERS ---

        function renderStandardCard(ticket) {
            const div = document.createElement('div');
            div.className = 'group bg-white border border-slate-200 rounded-xl p-5 hover:shadow-md transition-all duration-200';
            
            const startOfToday = new Date(); startOfToday.setHours(0,0,0,0);
            const dailyAffected = (ticket.affectedUsers || []).filter(u => u.timestamp?.toDate() > startOfToday);
            const count = dailyAffected.length;
            const iAmAffected = dailyAffected.some(u => u.name === currentUser.name);

            let actionBtn = '';
            if(iAmAffected) {
                actionBtn = `<button disabled class="w-full py-2 bg-slate-100 text-slate-500 font-medium rounded-lg text-sm flex items-center justify-center gap-2 cursor-not-allowed">
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg>
                    Reported Today
                </button>`;
            } else {
                actionBtn = `<button onclick="openAffectedModal('${ticket.id}')" class="w-full py-2 bg-secondary text-white font-medium rounded-lg text-sm hover:bg-secondary-dark transition shadow-sm hover:shadow active:scale-[0.98]">
                    I'm Affected
                </button>`;
            }

            let tlActions = '';
            if (currentUser.role === 'tl' && !ticket.isPermanent) {
                tlActions = `<button onclick="openCompleteModal('${ticket.id}')" class="mt-2 w-full py-2 border border-primary text-primary font-medium rounded-lg text-sm hover:bg-primary hover:text-white transition">Resolve Issue</button>`;
            }

            const timeString = ticket.isPermanent ? 'Permanent' : formatTimeAgo(ticket.createdAt);

            div.innerHTML = `
                <div class="flex justify-between items-start mb-2">
                    <h3 class="font-bold text-slate-800 text-lg leading-tight">${escapeHtml(ticket.title)}</h3>
                    <div class="flex flex-col items-end">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${count > 0 ? 'bg-red-100 text-red-800' : 'bg-slate-100 text-slate-600'}">
                            ${count} Affected
                        </span>
                    </div>
                </div>
                <p class="text-slate-600 text-sm mb-4 leading-relaxed">${escapeHtml(ticket.description)}</p>
                
                <div class="flex items-center justify-between text-xs text-slate-400 mb-4 border-t border-slate-50 pt-3">
                    <span>${timeString}</span>
                    ${currentUser.role === 'tl' && count > 0 ? `<button onclick="openAffectedList('${ticket.id}')" class="text-secondary hover:underline font-medium">View Guides</button>` : ''}
                </div>

                ${actionBtn}
                ${tlActions}
            `;
            return div;
        }

        function renderPendingCard(ticket) {
            const div = document.createElement('div');
            div.className = `bg-white border rounded-xl p-5 ${ticket.status === 'REJECTED' ? 'border-red-200 bg-red-50/30' : 'border-slate-200'}`;
            
            let buttons = '';
            if(ticket.status === 'REJECTED') {
                buttons = `<button onclick="updateTicketStatus('${ticket.id}', 'PENDING')" class="w-full py-2 bg-blue-500 text-white rounded-lg text-sm font-medium hover:bg-blue-600 transition">Reopen</button>`;
            } else {
                buttons = `
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="updateTicketStatus('${ticket.id}', 'REJECTED')" class="py-2 bg-white border border-red-500 text-red-500 rounded-lg text-sm font-medium hover:bg-red-50 transition">Reject</button>
                        <button onclick="updateTicketStatus('${ticket.id}', 'KNOWN')" class="py-2 bg-emerald-500 text-white rounded-lg text-sm font-medium hover:bg-emerald-600 transition shadow-sm">Approve</button>
                    </div>`;
            }

            div.innerHTML = `
                <div class="flex justify-between items-start">
                    <h3 class="font-bold text-slate-800 ${ticket.status === 'REJECTED' ? 'line-through opacity-60' : ''}">${escapeHtml(ticket.title)}</h3>
                    <span class="text-xs font-bold px-2 py-1 rounded bg-slate-100 text-slate-500">${ticket.name || 'Unknown'}</span>
                </div>
                <p class="text-slate-600 text-sm mt-2 mb-4 ${ticket.status === 'REJECTED' ? 'opacity-60' : ''}">${escapeHtml(ticket.description)}</p>
                ${buttons}
            `;
            return div;
        }

        function renderCompletedCard(ticket) {
            const div = document.createElement('div');
            div.className = 'bg-slate-50 border border-slate-200 rounded-xl p-5 opacity-80 hover:opacity-100 transition';
            
            div.innerHTML = `
                <div class="flex items-center gap-2 mb-2">
                    <div class="p-1 bg-green-100 text-green-600 rounded-full">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                    </div>
                    <h3 class="font-bold text-slate-700 line-through decoration-slate-400">${escapeHtml(ticket.title)}</h3>
                </div>
                <p class="text-slate-500 text-sm mb-3">${escapeHtml(ticket.description)}</p>
                
                <div class="bg-white border border-green-100 p-3 rounded-lg">
                    <p class="text-xs font-bold text-green-700 uppercase mb-1">Resolution</p>
                    <p class="text-sm text-slate-700">${escapeHtml(ticket.fixDescription || 'No details provided.')}</p>
                </div>
                <div class="mt-3 text-xs text-slate-400 text-right">
                    Fixed by ${ticket.resolverName} &bull; ${formatTimeAgo(ticket.completedAt)}
                </div>
            `;
            return div;
        }

        // --- LOGIC ---

        window.updateTicketStatus = async (id, status) => {
            try {
                const updateData = { status: status };
                if(status === 'KNOWN') {
                    updateData.acknowledgedAt = serverTimestamp();
                    updateData.approverName = currentUser.name;
                } else if(status === 'REJECTED') {
                    updateData.rejectedAt = serverTimestamp();
                    updateData.rejecterName = currentUser.name;
                }
                await updateDoc(doc(db, COLL.TICKETS, id), updateData);
                showToast(`Ticket ${status.toLowerCase()}`, "success");
            } catch(e) {
                showToast("Action failed", "error");
            }
        };

        // Modal Openers (Global Scope)
        window.openAffectedModal = (id) => {
            document.getElementById('affected-ticket-id').value = id;
            document.getElementById('affected-name').value = currentUser.name;
            toggleModal('affected-modal', true);
        };

        window.openCompleteModal = (id) => {
            document.getElementById('complete-ticket-id').value = id;
            toggleModal('complete-modal', true);
        };

        window.openAffectedList = (id) => {
            if(!globalSnapshot) return;
            const ticket = globalSnapshot.docs.find(d => d.id === id)?.data();
            if(!ticket) return;

            const startOfToday = new Date(); startOfToday.setHours(0,0,0,0);
            const list = (ticket.affectedUsers || []).filter(u => u.timestamp?.toDate() > startOfToday);
            list.sort((a,b) => b.timestamp.toDate() - a.timestamp.toDate());

            const container = document.getElementById('affected-guides-list');
            container.innerHTML = '';
            
            if(list.length === 0) {
                container.innerHTML = '<p class="text-slate-400 text-center py-4">No reports today.</p>';
            } else {
                list.forEach(u => {
                    const row = document.createElement('div');
                    row.className = 'flex justify-between items-center p-3 bg-white rounded border border-slate-200';
                    row.innerHTML = `
                        <div>
                            <div class="font-bold text-slate-700">${u.name}</div>
                            <div class="text-xs text-slate-400">EIN: ${u.ein || 'N/A'}</div>
                            ${u.comments ? `<div class="text-xs text-slate-500 mt-1 italic">"${escapeHtml(u.comments)}"</div>` : ''}
                        </div>
                        <div class="text-xs text-slate-400">${u.timestamp.toDate().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</div>
                    `;
                    container.appendChild(row);
                });
            }
            toggleModal('affected-guides-modal', true);
        };

        // --- EVENT LISTENERS & FORM HANDLING ---

        function setupEventListeners() {
            // Navigation
            els.navLinks.forEach(btn => {
                btn.addEventListener('click', () => {
                    currentPage = btn.dataset.page;
                    renderPage(currentPage);
                    closeSidebar();
                });
            });

            document.getElementById('hamburger-btn').addEventListener('click', openSidebar);
            els.sidebarOverlay.addEventListener('click', closeSidebar);
            document.getElementById('logout-btn').addEventListener('click', clearSession);

            // Search
            els.searchInput.addEventListener('input', (e) => {
                currentSearchTerm = e.target.value.toLowerCase();
                renderAppContent();
            });

            // Forms
            document.getElementById('new-ticket-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const title = document.getElementById('ticket-title').value;
                const desc = document.getElementById('ticket-desc').value;
                
                try {
                    await addDoc(collection(db, COLL.TICKETS), {
                        title: title,
                        description: desc,
                        status: 'PENDING',
                        createdAt: serverTimestamp(),
                        name: currentUser.name,
                        submitterId: currentUser.id,
                        affectedUsers: []
                    });
                    e.target.reset();
                    showToast("Issue submitted for review!", "success");
                    currentPage = 'known'; // Redirect to known (or pending if they could see it)
                    if(currentUser.role === 'tl') currentPage = 'pending';
                    renderPage(currentPage);
                } catch(err) {
                    showToast("Failed to submit issue", "error");
                }
            });

            document.getElementById('affected-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const id = document.getElementById('affected-ticket-id').value;
                const comments = document.getElementById('affected-comments').value;
                
                try {
                    const ticketRef = doc(db, COLL.TICKETS, id);
                    const ticketDoc = await getDoc(ticketRef);
                    const currentAffected = ticketDoc.data().affectedUsers || [];
                    
                    const newEntry = {
                        userId: currentUser.id,
                        name: currentUser.name,
                        ein: currentUser.ein,
                        comments: comments,
                        timestamp: new Date() // Client time is fine for day-filtering usually
                    };
                    
                    await updateDoc(ticketRef, { affectedUsers: [...currentAffected, newEntry] });
                    toggleModal('affected-modal', false);
                    showToast("Report added. Thank you!", "success");
                    document.getElementById('affected-comments').value = ''; // Reset
                } catch(err) {
                    showToast("Error submitting report", "error");
                }
            });

            document.getElementById('complete-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const id = document.getElementById('complete-ticket-id').value;
                const desc = document.getElementById('complete-description').value;

                try {
                    await updateDoc(doc(db, COLL.TICKETS, id), {
                        status: 'COMPLETE',
                        completedAt: serverTimestamp(),
                        fixDescription: desc,
                        resolverName: currentUser.name
                    });
                    toggleModal('complete-modal', false);
                    document.getElementById('complete-description').value = '';
                    showToast("Issue marked as resolved", "success");
                } catch(err) {
                    showToast("Error updating issue", "error");
                }
            });

            // Login Tabs
            const guideTab = document.getElementById('guide-tab-btn');
            const tlTab = document.getElementById('tl-tab-btn');
            const guideForm = document.getElementById('guide-login-form');
            const tlForm = document.getElementById('tl-login-form');

            guideTab.addEventListener('click', () => {
                guideTab.classList.add('bg-white', 'text-primary', 'shadow-sm');
                guideTab.classList.remove('text-slate-500');
                tlTab.classList.remove('bg-white', 'text-primary', 'shadow-sm');
                tlTab.classList.add('text-slate-500');
                guideForm.classList.remove('hidden');
                tlForm.classList.add('hidden');
            });

            tlTab.addEventListener('click', () => {
                tlTab.classList.add('bg-white', 'text-primary', 'shadow-sm');
                tlTab.classList.remove('text-slate-500');
                guideTab.classList.remove('bg-white', 'text-primary', 'shadow-sm');
                guideTab.classList.add('text-slate-500');
                tlForm.classList.remove('hidden');
                guideForm.classList.add('hidden');
            });

            // Login Submits
            guideForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const name = document.getElementById('name-input').value;
                const ein = document.getElementById('ein-input').value;
                if(name && ein) loginSuccess('guide', name, ein);
            });

            tlForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const code = document.getElementById('tl-code-input').value;
                // In a real app, verify code against DB. For single file, assuming code works if exists.
                // We check the TL Codes collection
                try {
                    const docRef = doc(db, COLL.TL_CODES, code);
                    const docSnap = await getDoc(docRef);
                    if(docSnap.exists()) {
                        loginSuccess('tl', docSnap.data().name, null);
                    } else {
                        showToast("Invalid Access Code", "error");
                    }
                } catch(err) {
                    // Fallback for demo if DB not set up
                    if(code === "admin123") loginSuccess('tl', "Demo Admin", null);
                    else showToast("Verification failed", "error");
                }
            });
            
            // Modals
            document.querySelectorAll('.modal-close-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const modal = btn.closest('.modal');
                    toggleModal(modal.id, false);
                });
            });
        }

        // --- UI HELPERS ---

        function renderPage(pageName) {
            els.pages.forEach(p => p.classList.add('hidden'));
            document.getElementById(`page-${pageName}`).classList.remove('hidden');
            
            els.headerTitle.textContent = document.querySelector(`button[data-page="${pageName}"]`).textContent.trim();
            
            // Highlight Nav
            els.navLinks.forEach(l => {
                if(l.dataset.page === pageName) l.classList.add('bg-slate-50', 'text-primary');
                else l.classList.remove('bg-slate-50', 'text-primary');
            });

            // Show/Hide Search
            if(['known', 'completed', 'pending'].includes(pageName)) els.searchContainer.classList.remove('hidden');
            else els.searchContainer.classList.add('hidden');
        }

        function openSidebar() {
            els.sidebar.classList.remove('-translate-x-full');
            els.sidebarOverlay.classList.remove('opacity-0', 'pointer-events-none');
        }

        function closeSidebar() {
            els.sidebar.classList.add('-translate-x-full');
            els.sidebarOverlay.classList.add('opacity-0', 'pointer-events-none');
        }

        function toggleModal(modalId, show) {
            const modal = document.getElementById(modalId);
            if(show) {
                els.modalBackdrop.classList.remove('hidden');
                // small delay to allow display:block to apply before opacity transition
                setTimeout(() => {
                    els.modalBackdrop.classList.remove('opacity-0');
                    modal.classList.add('active');
                }, 10);
            } else {
                modal.classList.remove('active');
                els.modalBackdrop.classList.add('opacity-0');
                setTimeout(() => els.modalBackdrop.classList.add('hidden'), 300);
            }
        }

        // --- METRICS & UTILS ---

        function updateMetrics(tickets, startOfToday) {
            let totalAffected = 0;
            const uniqueUsers = new Set();
            const issueCounts = [];

            tickets.forEach(t => {
                if(t.status === 'KNOWN') {
                    const daily = (t.affectedUsers || []).filter(u => u.timestamp?.toDate() > startOfToday);
                    totalAffected += daily.length;
                    daily.forEach(u => uniqueUsers.add(u.name));
                    if(daily.length > 0) issueCounts.push({ title: t.title, count: daily.length });
                }
            });

            // Update DOM
            document.getElementById('metric-total-affected').textContent = totalAffected;
            document.getElementById('metric-unique-affected').textContent = uniqueUsers.size;

            // Top 5
            issueCounts.sort((a,b) => b.count - a.count);
            const top5 = issueCounts.slice(0, 5);
            const top5List = document.getElementById('top-5-list');
            top5List.innerHTML = '';
            
            if(top5.length === 0) top5List.innerHTML = '<p class="text-xs text-slate-400">No data available yet today.</p>';
            else {
                top5.forEach((item, idx) => {
                    const row = document.createElement('div');
                    row.className = 'flex items-center justify-between text-sm border-b border-slate-100 pb-2 last:border-0';
                    row.innerHTML = `
                        <div class="flex items-center gap-3">
                            <span class="font-bold text-slate-300 text-lg">0${idx+1}</span>
                            <span class="font-medium text-slate-700 truncate max-w-[150px] sm:max-w-xs">${escapeHtml(item.title)}</span>
                        </div>
                        <span class="font-bold text-secondary">${item.count}</span>
                    `;
                    top5List.appendChild(row);
                });
            }

            // Chart
            if(metricsChart) metricsChart.destroy();
            const ctx = document.getElementById('metrics-pie-chart').getContext('2d');
            
            const labels = top5.map(i => i.title.length > 15 ? i.title.substring(0,15)+'...' : i.title);
            const data = top5.map(i => i.count);
            // Add "Other" if needed
            const otherCount = totalAffected - data.reduce((a,b) => a+b, 0);
            if(otherCount > 0) { labels.push('Other'); data.push(otherCount); }

            metricsChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: ['#6400aa', '#009ba4', '#a855f7', '#2dd4bf', '#f472b6', '#cbd5e1'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    cutout: '70%'
                }
            });
        }

        function formatTimeAgo(timestamp) {
            if (!timestamp) return 'Recently';
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            const seconds = Math.floor((new Date() - date) / 1000);
            
            let interval = seconds / 31536000;
            if (interval > 1) return Math.floor(interval) + "y ago";
            interval = seconds / 2592000;
            if (interval > 1) return Math.floor(interval) + "mo ago";
            interval = seconds / 86400;
            if (interval > 1) return Math.floor(interval) + "d ago";
            interval = seconds / 3600;
            if (interval > 1) return Math.floor(interval) + "h ago";
            interval = seconds / 60;
            if (interval > 1) return Math.floor(interval) + "m ago";
            return "Just now";
        }

        function escapeHtml(text) {
            if (!text) return "";
            return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
        }

        // Run
        init();
    </script>
</body>
</html>
